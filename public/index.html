<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absen PMR</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:Arial; background:#e8e8e8; padding:20px; }

    .container { max-width:750px; margin:0 auto; display:flex; flex-direction:column; gap:14px; }

    h2 { text-align:center; color:#4472c4; margin-bottom:4px; }
    .subtitle { text-align:center; font-size:11px; color:#888; margin-bottom:8px; }

    .card {
      background:#fff; padding:20px; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .card h3 {
      font-size:13px; color:#333; margin-bottom:12px;
      border-bottom:2px solid #4472c4; padding-bottom:6px;
    }

    label { display:block; font-size:11px; font-weight:bold; color:#555; margin-top:10px; }
    input {
      width:100%; padding:7px 9px; margin-top:3px;
      border:1px solid #ccc; border-radius:4px; font-size:12px;
    }
    input:focus { outline:none; border-color:#4472c4; }

    .row { display:flex; gap:8px; }
    .row > div { flex:1; }

    .btn {
      padding:8px 16px; border:none; border-radius:5px;
      font-size:12px; font-weight:bold; cursor:pointer; margin-top:10px;
    }
    .btn-blue  { background:#4472c4; color:#fff; width:100%; padding:11px; font-size:13px; }
    .btn-blue:hover  { background:#2f5496; }
    .btn-green { background:#375623; color:#fff; }
    .btn-green:hover { background:#1f3714; }
    .btn-red   { background:#c00000; color:#fff; font-size:11px; padding:4px 9px; margin:0; }
    .btn-red:hover   { background:#8b0000; }
    .btn-gray  { background:#555; color:#fff; font-size:11px; padding:4px 9px; margin:0; }
    .btn-gray:hover  { background:#333; }
    .btn-save  { background:#7b3f00; color:#fff; font-size:11px; padding:4px 9px; margin:0; }
    .btn-save:hover  { background:#5a2d00; }
    .btn:disabled { background:#aaa !important; cursor:not-allowed; }

    /* Tabel */
    table { width:100%; border-collapse:collapse; font-size:11px; margin-top:12px; }
    th { background:#4472c4; color:#fff; padding:6px 8px; text-align:center; border:1px solid #2f5496; }
    td { border:1px solid #ddd; padding:5px 7px; text-align:center; vertical-align:middle; }
    td.td-nama { text-align:left; }
    td input {
      border:1px dashed #aaa; background:#fffde7;
      padding:3px 5px; font-size:11px; width:100%; margin:0;
    }
    tr:nth-child(even) td { background:#f5f8ff; }
    tr:nth-child(even) td input { background:#fff9c4; }

    .aksi-btn { display:flex; gap:4px; justify-content:center; }

    .status { font-size:11px; margin-top:8px; text-align:center; min-height:16px; font-weight:bold; }
    .ok  { color:#375623; }
    .err { color:#c00000; }

    .tgl-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:4px; }

    .info-total {
      font-size:11px; color:#555; text-align:right;
      margin-top:6px; font-style:italic;
    }
  </style>
</head>
<body>
<div class="container">

  <div>
    <h2>üìã Sistem Absensi PMR</h2>
    <p class="subtitle">SMK Negeri 1 Stabat</p>
  </div>

  <!-- CARD: DATA SISWA -->
  <div class="card">
    <h3>üë• Data Siswa</h3>

    <div class="row">
      <div>
        <label>NISN</label>
        <input type="text" id="inNisn" placeholder="contoh: 0101234567">
      </div>
      <div style="flex:2">
        <label>Nama Lengkap</label>
        <input type="text" id="inNama" placeholder="contoh: BUDI SANTOSO">
      </div>
      <div>
        <label>Kelas</label>
        <input type="text" id="inKelas" placeholder="contoh: X DPIB 1">
      </div>
    </div>
    <button class="btn btn-green" onclick="tambahSiswa()">Ôºã Tambah Siswa</button>
    <p class="status ok" id="statusSiswa"></p>

    <table>
      <thead>
        <tr>
          <th style="width:5%">NO</th>
          <th style="width:15%">NISN</th>
          <th>NAMA</th>
          <th style="width:13%">KELAS</th>
          <th style="width:20%">AKSI</th>
        </tr>
      </thead>
      <tbody id="tbodySiswa"></tbody>
    </table>
    <p class="info-total" id="totalSiswa"></p>
  </div>

  <!-- CARD: GENERATE PDF -->
  <div class="card">
    <h3>üìÑ Generate PDF Daftar Hadir</h3>

    <label>Nama Pelatih</label>
    <input type="text" id="pelatih" value="Susianto">

    <label>Tahun Pelajaran</label>
    <input type="text" id="tahun" value="2025-2026">

    <label>Tanggal Pertemuan (isi yang diperlukan saja)</label>
    <div class="tgl-grid">
      <input type="date" id="tgl1">
      <input type="date" id="tgl2">
      <input type="date" id="tgl3">
      <input type="date" id="tgl4">
    </div>

    <button class="btn btn-blue" id="btnPDF" onclick="downloadPDF()">
      ‚¨áÔ∏è Download PDF Daftar Hadir
    </button>
    <p class="status" id="statusPDF"></p>
  </div>

</div>

<script>
  // ===== LOAD TABEL SISWA =====
  async function loadSiswa() {
    const res  = await fetch('/api/siswa');
    const data = await res.json();
    const tb   = document.getElementById('tbodySiswa');
    tb.innerHTML = '';

    data.forEach((s, i) => {
      tb.innerHTML += `
        <tr id="row-${s.nisn}">
          <td>${i + 1}</td>
          <td>${s.nisn}</td>
          <td class="td-nama" id="nama-${s.nisn}">${s.nama}</td>
          <td id="kelas-${s.nisn}">${s.kelas}</td>
          <td>
            <div class="aksi-btn">
              <button class="btn btn-gray" onclick="editMode('${s.nisn}','${s.nama}','${s.kelas}')">‚úèÔ∏è</button>
              <button class="btn btn-red"  onclick="hapusSiswa('${s.nisn}')">‚úï</button>
            </div>
          </td>
        </tr>`;
    });

    document.getElementById('totalSiswa').textContent =
      `Total: ${data.length} siswa terdaftar`;
  }

  // ===== MODE EDIT =====
  function editMode(nisn, nama, kelas) {
    document.getElementById(`nama-${nisn}`).innerHTML =
      `<input type="text" id="edit-nama-${nisn}" value="${nama}">`;
    document.getElementById(`kelas-${nisn}`).innerHTML =
      `<input type="text" id="edit-kelas-${nisn}" value="${kelas}" style="width:80px">`;

    // Ganti tombol aksi
    const aksi = document.querySelector(`#row-${nisn} .aksi-btn`);
    aksi.innerHTML = `
      <button class="btn btn-save" onclick="simpanEdit('${nisn}')">üíæ</button>
      <button class="btn btn-gray" onclick="loadSiswa()">‚úï</button>
    `;
  }

  // ===== SIMPAN EDIT =====
  async function simpanEdit(nisn) {
    const nama  = document.getElementById(`edit-nama-${nisn}`).value.trim();
    const kelas = document.getElementById(`edit-kelas-${nisn}`).value.trim();
    const status = document.getElementById('statusSiswa');

    if (!nama || !kelas) {
      status.className = 'status err';
      status.textContent = '‚ùå Nama dan Kelas tidak boleh kosong!';
      return;
    }

    const res  = await fetch(`/api/siswa/${nisn}`, {
      method : 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body   : JSON.stringify({ nama, kelas })
    });
    const data = await res.json();

    if (res.ok) {
      status.className = 'status ok';
      status.textContent = '‚úÖ ' + data.pesan;
      loadSiswa();
    } else {
      status.className = 'status err';
      status.textContent = '‚ùå ' + data.error;
    }
  }

  // ===== TAMBAH SISWA =====
  async function tambahSiswa() {
    const nisn   = document.getElementById('inNisn').value.trim();
    const nama   = document.getElementById('inNama').value.trim();
    const kelas  = document.getElementById('inKelas').value.trim();
    const status = document.getElementById('statusSiswa');

    if (!nisn || !nama || !kelas) {
      status.className = 'status err';
      status.textContent = '‚ùå Semua kolom wajib diisi!';
      return;
    }

    const res  = await fetch('/api/siswa', {
      method : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body   : JSON.stringify({ nisn, nama, kelas })
    });
    const data = await res.json();

    if (res.ok) {
      status.className = 'status ok';
      status.textContent = '‚úÖ ' + data.pesan;
      document.getElementById('inNisn').value  = '';
      document.getElementById('inNama').value  = '';
      document.getElementById('inKelas').value = '';
      loadSiswa();
    } else {
      status.className = 'status err';
      status.textContent = '‚ùå ' + data.error;
    }
  }

  // ===== HAPUS SISWA =====
  async function hapusSiswa(nisn) {
    if (!confirm('Hapus siswa dengan NISN ' + nisn + '?')) return;
    const res  = await fetch('/api/siswa/' + nisn, { method: 'DELETE' });
    const data = await res.json();
    const status = document.getElementById('statusSiswa');

    if (res.ok) {
      status.className = 'status ok';
      status.textContent = '‚úÖ ' + data.pesan;
      loadSiswa();
    } else {
      status.className = 'status err';
      status.textContent = '‚ùå ' + data.error;
    }
  }

  // ===== DOWNLOAD PDF =====
  async function downloadPDF() {
    const btn    = document.getElementById('btnPDF');
    const status = document.getElementById('statusPDF');
    btn.disabled = true;
    status.className = 'status';
    status.textContent = '‚è≥ Sedang membuat PDF...';

    const tanggal = ['tgl1','tgl2','tgl3','tgl4']
      .map(id => document.getElementById(id).value)
      .filter(t => t);

    if (tanggal.length === 0) {
      status.className = 'status err';
      status.textContent = '‚ùå Isi minimal 1 tanggal pertemuan!';
      btn.disabled = false;
      return;
    }

    try {
      const res = await fetch('/generate-pdf', {
        method : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body   : JSON.stringify({
          pelatih: document.getElementById('pelatih').value,
          tahun  : document.getElementById('tahun').value,
          tanggal
        })
      });

      if (!res.ok) throw new Error('Gagal');

      const blob = await res.blob();
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'daftar-hadir-pmr.pdf';
      a.click();
      URL.revokeObjectURL(url);

      status.className = 'status ok';
      status.textContent = '‚úÖ PDF berhasil didownload!';
    } catch(e) {
      status.className = 'status err';
      status.textContent = '‚ùå Gagal membuat PDF, cek CMD.';
    }

    btn.disabled = false;
  }

  loadSiswa();
</script>
</body>
</html>