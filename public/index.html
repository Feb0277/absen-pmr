<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absen PMR</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:Arial; background:#f0f4f8; color:#222; }

    /* HEADER */
    .header {
      background: #4472c4;
      color: #fff;
      padding: 16px 20px;
      text-align: center;
    }
    .header h1 { font-size: 18px; }
    .header p  { font-size: 11px; opacity: 0.8; margin-top: 2px; }

    /* NAV TAB */
    .nav {
      display: flex;
      background: #2f5496;
    }
    .nav button {
      flex: 1; padding: 12px 4px;
      background: none; border: none;
      color: #fff; font-size: 12px;
      font-weight: bold; cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: 0.2s;
    }
    .nav button.active { border-bottom: 3px solid #fff; background: rgba(255,255,255,0.1); }

    /* HALAMAN */
    .page { display: none; padding: 16px; max-width: 600px; margin: 0 auto; }
    .page.active { display: block; }

    /* CARD */
    .card {
      background: #fff; border-radius: 10px;
      padding: 16px; margin-bottom: 14px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
    }
    .card h3 { font-size: 13px; color: #4472c4; margin-bottom: 12px; }

    label { display:block; font-size:11px; font-weight:bold; color:#555; margin-top:10px; }
    input, select {
      width:100%; padding:10px; margin-top:4px;
      border:1px solid #ddd; border-radius:8px;
      font-size:13px; background:#fafafa;
    }
    input:focus { outline:none; border-color:#4472c4; background:#fff; }

    /* TOMBOL */
    .btn {
      width:100%; padding:13px; border:none;
      border-radius:8px; font-size:14px;
      font-weight:bold; cursor:pointer;
      margin-top:12px; transition:0.2s;
    }
    .btn-blue  { background:#4472c4; color:#fff; }
    .btn-blue:hover  { background:#2f5496; }
    .btn-green { background:#375623; color:#fff; }
    .btn-green:hover { background:#1f3714; }
    .btn:disabled { background:#aaa !important; cursor:not-allowed; }

    /* STATUS */
    .status {
      text-align:center; font-size:12px;
      font-weight:bold; margin-top:10px;
      min-height:18px; padding:4px;
      border-radius:6px;
    }
    .ok  { color:#375623; background:#f0faf0; }
    .err { color:#c00000; background:#fff0f0; }

    /* SUMBER DATA */
    .sumber-btn {
      display: flex; gap: 8px; margin-top: 8px;
    }
    .sumber-btn button {
      flex:1; padding:10px; border-radius:8px;
      border: 2px solid #ddd; background:#fafafa;
      font-size:12px; font-weight:bold; cursor:pointer;
      transition:0.2s; color:#555;
    }
    .sumber-btn button.active {
      border-color:#4472c4; background:#eef2ff; color:#4472c4;
    }

    /* TANGGAL GRID */
    .tgl-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px; }

    /* DAFTAR SISWA */
    .siswa-item {
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border:1px solid #eee;
      border-radius:8px; margin-bottom:8px;
      background:#fafafa;
    }
    .siswa-info { flex:1; }
    .siswa-nama { font-size:13px; font-weight:bold; color:#222; }
    .siswa-sub  { font-size:11px; color:#888; margin-top:2px; }
    .siswa-aksi { display:flex; gap:6px; }
    .btn-sm {
      padding:6px 10px; border:none; border-radius:6px;
      font-size:11px; font-weight:bold; cursor:pointer;
    }
    .btn-edit { background:#e8edf8; color:#4472c4; }
    .btn-del  { background:#ffe8e8; color:#c00000; }

    /* FORM TAMBAH */
    .form-tambah { border-top:1px solid #eee; margin-top:14px; padding-top:14px; }
    .form-tambah h4 { font-size:12px; color:#555; margin-bottom:4px; }

    /* LOADING */
    .loading {
      text-align:center; padding:20px;
      color:#888; font-size:12px;
    }

    /* MODAL EDIT */
    .modal-bg {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.5); z-index:100;
      align-items:center; justify-content:center;
    }
    .modal-bg.show { display:flex; }
    .modal {
      background:#fff; border-radius:12px;
      padding:20px; width:90%; max-width:400px;
    }
    .modal h3 { font-size:14px; color:#4472c4; margin-bottom:12px; }
    .modal-aksi { display:flex; gap:8px; margin-top:12px; }
    .modal-aksi button {
      flex:1; padding:10px; border:none;
      border-radius:8px; font-size:13px;
      font-weight:bold; cursor:pointer;
    }
    .btn-simpan { background:#4472c4; color:#fff; }
    .btn-batal  { background:#eee; color:#555; }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <h1>üìã Sistem Absensi PMR</h1>
  <p>SMK Negeri 1 Stabat</p>
</div>

<!-- NAV -->
<div class="nav">
  <button class="active" onclick="gotoTab('tabPDF', this)">üìÑ Generate PDF</button>
  <button onclick="gotoTab('tabSiswa', this)">üë• Data Siswa</button>
</div>

<!-- ===== TAB 1: GENERATE PDF ===== -->
<div class="page active" id="tabPDF">

  <div class="card">
    <h3>‚öôÔ∏è Pengaturan</h3>

    <label>Nama Pelatih</label>
    <input type="text" id="pelatih" value="Susianto">

    <label>Tahun Pelajaran</label>
    <input type="text" id="tahun" value="2025-2026">
  </div>

  <div class="card">
    <h3>üìÖ Tanggal Pertemuan</h3>
    <div class="tgl-grid">
      <div><label>Pertemuan 1</label><input type="date" id="tgl1"></div>
      <div><label>Pertemuan 2</label><input type="date" id="tgl2"></div>
      <div><label>Pertemuan 3</label><input type="date" id="tgl3"></div>
      <div><label>Pertemuan 4</label><input type="date" id="tgl4"></div>
    </div>
  </div>

  <div class="card">
    <h3>üë• Sumber Data Siswa</h3>
    <div class="sumber-btn">
      <button id="btnDariServer" class="active" onclick="pilihSumber('server')">
        üóÑÔ∏è Dari Database
      </button>
      <button id="btnManual" onclick="pilihSumber('manual')">
        ‚úèÔ∏è Input Manual
      </button>
    </div>

    <!-- Manual input (tersembunyi by default) -->
    <div id="inputManual" style="display:none; margin-top:12px;">
      <p style="font-size:11px; color:#888; margin-bottom:8px;">
        Ketik NISN, Nama, Kelas ‚Äî satu siswa per baris, pisahkan dengan koma.<br>
        Contoh: <code>0106524645, BUDI SANTOSO, X DPIB 1</code>
      </p>
      <textarea id="txtManual" rows="6"
        style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:12px;resize:vertical;"
        placeholder="0106524645, BUDI SANTOSO, X DPIB 1&#10;0104302847, SITI RAHAYU, X DPIB 2"></textarea>
    </div>
  </div>

  <button class="btn btn-blue" id="btnDownload" onclick="downloadPDF()">
    ‚¨áÔ∏è Download PDF Daftar Hadir
  </button>
  <p class="status" id="statusPDF"></p>

</div>

<!-- ===== TAB 2: DATA SISWA ===== -->
<div class="page" id="tabSiswa">

  <div class="card">
    <h3>üë• Daftar Siswa</h3>
    <div id="listSiswa"><div class="loading">‚è≥ Memuat data...</div></div>
    <p style="font-size:11px;color:#888;text-align:right;margin-top:6px;" id="totalSiswa"></p>

    <!-- Form tambah -->
    <div class="form-tambah">
      <h4>Ôºã Tambah Siswa Baru</h4>
      <label>NISN</label>
      <input type="text" id="inNisn" placeholder="contoh: 0101234567">
      <label>Nama Lengkap</label>
      <input type="text" id="inNama" placeholder="contoh: BUDI SANTOSO">
      <label>Kelas</label>
      <input type="text" id="inKelas" placeholder="contoh: X DPIB 1">
      <button class="btn btn-green" onclick="tambahSiswa()">Ôºã Tambah Siswa</button>
      <p class="status" id="statusSiswa"></p>
    </div>
  </div>

</div>

<!-- MODAL EDIT -->
<div class="modal-bg" id="modalEdit">
  <div class="modal">
    <h3>‚úèÔ∏è Edit Data Siswa</h3>
    <input type="hidden" id="editNisn">
    <label>Nama</label>
    <input type="text" id="editNama">
    <label>Kelas</label>
    <input type="text" id="editKelas">
    <div class="modal-aksi">
      <button class="btn-batal"  onclick="tutupModal()">Batal</button>
      <button class="btn-simpan" onclick="simpanEdit()">üíæ Simpan</button>
    </div>
  </div>
</div>

<script>
  let sumberData = 'server';

  // ===== TAB NAVIGATION =====
  function gotoTab(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
    if (id === 'tabSiswa') loadSiswa();
  }

  // ===== PILIH SUMBER DATA =====
  function pilihSumber(mode) {
    sumberData = mode;
    document.getElementById('btnDariServer').classList.toggle('active', mode === 'server');
    document.getElementById('btnManual').classList.toggle('active', mode === 'manual');
    document.getElementById('inputManual').style.display = mode === 'manual' ? 'block' : 'none';
  }

  // ===== LOAD SISWA =====
  async function loadSiswa() {
    const list = document.getElementById('listSiswa');
    list.innerHTML = '<div class="loading">‚è≥ Memuat data...</div>';
    try {
      const res  = await fetch('/api/siswa');
      const data = await res.json();
      document.getElementById('totalSiswa').textContent = `Total: ${data.length} siswa`;

      if (data.length === 0) {
        list.innerHTML = '<div class="loading">Belum ada data siswa.</div>';
        return;
      }

      list.innerHTML = data.map(s => `
        <div class="siswa-item">
          <div class="siswa-info">
            <div class="siswa-nama">${s.nama}</div>
            <div class="siswa-sub">${s.nisn} &bull; ${s.kelas}</div>
          </div>
          <div class="siswa-aksi">
            <button class="btn-sm btn-edit" onclick="bukaEdit('${s.nisn}','${s.nama}','${s.kelas}')">‚úèÔ∏è</button>
            <button class="btn-sm btn-del"  onclick="hapusSiswa('${s.nisn}')">‚úï</button>
          </div>
        </div>
      `).join('');
    } catch(e) {
      list.innerHTML = '<div class="loading">‚ùå Gagal memuat data.</div>';
    }
  }

  // ===== TAMBAH SISWA =====
  async function tambahSiswa() {
    const nisn   = document.getElementById('inNisn').value.trim();
    const nama   = document.getElementById('inNama').value.trim();
    const kelas  = document.getElementById('inKelas').value.trim();
    const status = document.getElementById('statusSiswa');

    if (!nisn || !nama || !kelas) {
      status.className = 'status err';
      status.textContent = '‚ùå Semua kolom wajib diisi!';
      return;
    }

    const res  = await fetch('/api/siswa', {
      method : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body   : JSON.stringify({ nisn, nama, kelas })
    });
    const data = await res.json();

    if (res.ok) {
      status.className = 'status ok';
      status.textContent = '‚úÖ ' + data.pesan;
      document.getElementById('inNisn').value  = '';
      document.getElementById('inNama').value  = '';
      document.getElementById('inKelas').value = '';
      loadSiswa();
    } else {
      status.className = 'status err';
      status.textContent = '‚ùå ' + data.error;
    }
  }

  // ===== HAPUS SISWA =====
  async function hapusSiswa(nisn) {
    if (!confirm('Hapus siswa ini?')) return;
    const res  = await fetch('/api/siswa/' + nisn, { method: 'DELETE' });
    const data = await res.json();
    const status = document.getElementById('statusSiswa');
    if (res.ok) {
      status.className = 'status ok';
      status.textContent = '‚úÖ ' + data.pesan;
      loadSiswa();
    } else {
      status.className = 'status err';
      status.textContent = '‚ùå ' + data.error;
    }
  }

  // ===== MODAL EDIT =====
  function bukaEdit(nisn, nama, kelas) {
    document.getElementById('editNisn').value  = nisn;
    document.getElementById('editNama').value  = nama;
    document.getElementById('editKelas').value = kelas;
    document.getElementById('modalEdit').classList.add('show');
  }

  function tutupModal() {
    document.getElementById('modalEdit').classList.remove('show');
  }

  async function simpanEdit() {
    const nisn  = document.getElementById('editNisn').value;
    const nama  = document.getElementById('editNama').value.trim();
    const kelas = document.getElementById('editKelas').value.trim();
    const status = document.getElementById('statusSiswa');

    const res  = await fetch(`/api/siswa/${nisn}`, {
      method : 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body   : JSON.stringify({ nama, kelas })
    });
    const data = await res.json();

    tutupModal();
    if (res.ok) {
      status.className = 'status ok';
      status.textContent = '‚úÖ ' + data.pesan;
      loadSiswa();
    } else {
      status.className = 'status err';
      status.textContent = '‚ùå ' + data.error;
    }
  }

  // ===== DOWNLOAD PDF =====
  async function downloadPDF() {
    const btn    = document.getElementById('btnDownload');
    const status = document.getElementById('statusPDF');
    btn.disabled = true;
    status.className = 'status';
    status.textContent = '‚è≥ Sedang membuat PDF...';

    const tanggal = ['tgl1','tgl2','tgl3','tgl4']
      .map(id => document.getElementById(id).value)
      .filter(t => t);

    if (tanggal.length === 0) {
      status.className = 'status err';
      status.textContent = '‚ùå Isi minimal 1 tanggal pertemuan!';
      btn.disabled = false;
      return;
    }

    // Siapkan data siswa manual jika dipilih
    let siswaManual = [];
    if (sumberData === 'manual') {
      const baris = document.getElementById('txtManual').value.trim().split('\n');
      siswaManual = baris.map(b => {
        const [nisn, nama, kelas] = b.split(',').map(s => s.trim());
        return { nisn, nama, kelas };
      }).filter(s => s.nisn && s.nama && s.kelas);

      if (siswaManual.length === 0) {
        status.className = 'status err';
        status.textContent = '‚ùå Data manual tidak valid!';
        btn.disabled = false;
        return;
      }
    }

    try {
      const res = await fetch('/generate-pdf', {
        method : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body   : JSON.stringify({
          pelatih     : document.getElementById('pelatih').value,
          tahun       : document.getElementById('tahun').value,
          tanggal,
          sumber      : sumberData,
          siswaManual
        })
      });

      if (!res.ok) throw new Error('Gagal');

      const blob = await res.blob();
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'daftar-hadir-pmr.pdf';
      a.click();
      URL.revokeObjectURL(url);

      status.className = 'status ok';
      status.textContent = '‚úÖ PDF berhasil didownload!';
    } catch(e) {
      status.className = 'status err';
      status.textContent = '‚ùå Gagal membuat PDF.';
    }

    btn.disabled = false;
  }
</script>
</body>
</html>